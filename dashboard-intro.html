<style>
  /* Legacy IntroJS styles preserved for reference */
  .introjs-tooltipReferenceLayer {
    font-family: inherit;
  }
  .introjs-tooltip {
    min-width: 600px;
    background-color: #ffe0b6;
    box-shadow: 0px 4px 32px -4px #ffe0b6;
  }

  @media (max-width: 768px) {
    .introjs-tooltip {
      min-width: unset;
    }
  }
  .introjs-tooltiptext {
    padding: 10px 20px;
  }

  /* Shepherd.js custom styles */
  .shepherd-element {
    background-color: #ffe0b6 !important;
    box-shadow: 0px 4px 32px -4px #ffe0b6 !important;
    min-width: 600px;
    border-radius: 8px;
    border: none;
    font-family: inherit;
    z-index: 1000001;
  }

  @media (max-width: 768px) {
    .shepherd-element {
      min-width: unset;
      max-width: 90vw;
    }
  }

  .shepherd-content {
    padding: 10px 20px;
  }

  .shepherd-text {
    color: #1f1f1f;
    font-size: 14px;
    line-height: 1.5;
  }

  .shepherd-header {
    display: none; /* Hide default title as we use custom content */
  }

  .shepherd-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    border-top: 1px solid #514f6e26;
    padding-top: 10px;
    margin-top: 10px;
  }

  .shepherd-button {
    padding: 3px 2px;
    border: 0px;
    background-color: #ffe0b6;
    font-weight: 600;
    position: relative;
    cursor: pointer;
    color: #1f1f1f;
    font-size: 14px;
  }

  .shepherd-button:hover {
    background-color: #ffe0b6;
    opacity: 0.8;
  }

  .shepherd-button-secondary {
    background-color: transparent;
  }

  /* Custom intro content styles */
  .custom-intro-content {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .intro-lottie-container {
    width: 120px;
    height: 120px;
    flex-shrink: 0;
  }

  .content-side {
    flex: 1;
  }

  .intro-title {
    padding-bottom: 10px;
    font-weight: 600;
    font-size: 16px;
    color: #1f1f1f;
    margin: 0;
  }

  .intro-description {
    line-height: 1.5;
    color: #1f1f1f;
    font-weight: 400;
    margin: 0;
    font-size: 14px;
  }

  /* Shepherd arrow styles */
  .shepherd-arrow,
  .shepherd-arrow:before {
    position: absolute;
    width: 0;
    height: 0;
    border-style: solid;
  }

  .shepherd-element[data-popper-placement^="top"] > .shepherd-arrow {
    bottom: -8px;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 8px solid #ffe0b6;
  }

  .shepherd-element[data-popper-placement^="bottom"] > .shepherd-arrow {
    top: -8px;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-bottom: 8px solid #ffe0b6;
  }

  .shepherd-element[data-popper-placement^="left"] > .shepherd-arrow {
    right: -8px;
    border-top: 8px solid transparent;
    border-bottom: 8px solid transparent;
    border-left: 8px solid #ffe0b6;
  }

  .shepherd-element[data-popper-placement^="right"] > .shepherd-arrow {
    left: -8px;
    border-top: 8px solid transparent;
    border-bottom: 8px solid transparent;
    border-right: 8px solid #ffe0b6;
  }

  /* Modal overlay styles */
  .shepherd-modal-overlay-container {
    background-color: rgba(0, 0, 0, 0.75);
    z-index: 1000000;
  }

  /* Cancel icon styles */
  .shepherd-cancel-icon {
    position: absolute;
    right: 10px;
    top: 10px;
    background: none;
    border: none;
    font-size: 16px;
    cursor: pointer;
    color: #1f1f1f;
  }

  .shepherd-cancel-icon:hover {
    opacity: 0.7;
  }

  /* Legacy styles for compatibility */
  .introjs-arrow.right {
    border-left-color: #ffe0b6 !important;
  }

  .introjs-arrow.left {
    border-right-color: #ffe0b6 !important;
  }
  .introjs-arrow.top {
    border-bottom-color: #ffe0b6 !important;
  }
  .introjs-arrow.bottom {
    border-top-color: #ffe0b6 !important;
  }
  .introjs-tooltip-title {
    display: none;
  }
  .introjs-helperNumberLayer {
    position: absolute;
    left: 10px;
    color: #1f1f1f;
  }
  .introjs-tooltipbuttons {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    border-color: #514f6e26;
  }
  .introjs-button {
    padding: 3px 2px;
    border: 0px;
    background-color: #ffe0b6;
    font-weight: 600;
    position: relative;
  }
  .introjs-button:hover {
    background-color: #ffe0b6;
  }
</style>

<script>
  // Wait for page to load
  document.addEventListener("DOMContentLoaded", function () {
    // Check if user has already seen the tour
    async function checkIfShouldRunTour() {
      try {
        if (typeof window.$memberstackDom !== "undefined") {
          const { data: member } =
            await window.$memberstackDom.getCurrentMember();

          if (member) {
            const memberJson = await window.$memberstackDom.getMemberJSON();

            // Only run tour if hasLoggedInBefore is null, undefined, or false
            if (memberJson.data.hasLoggedInBefore === true) {
              console.log("User has already seen the tour, skipping...");
              return false;
            }
          }
        }
        return true; // Run tour for new users or when memberstack is not available
      } catch (error) {
        console.error("Error checking tour status:", error);
        return true; // Run tour on error to be safe
      }
    }

    // Initialize tour only if conditions are met
    checkIfShouldRunTour().then((shouldRun) => {
      console.log("🎭 Tour should run:", shouldRun);
      if (!shouldRun) {
        console.log("❌ Tour cancelled - user has already seen it");
        return;
      }

      console.log("✅ Initializing tour for new user");

      // Pre-load Lottie animation data
      let lottieAnimationData = null;

      // Load animation JSON once
      fetch(
        "https://cdn.prod.website-files.com/67e360f08a15ef65d8814b41/6836fc39d91ffe6feec2f253_data5.json"
      )
        .then((response) => response.json())
        .then((data) => {
          lottieAnimationData = data;
        })
        .catch((error) => {
          console.error("Error loading Lottie animation:", error);
        });

      // Helper function to create intro content with Lottie
      function createIntroContent(title, description) {
        return `
          <div class="custom-intro-content">
            <div class="lottie-side">
              <div class="intro-lottie-container"></div>
            </div>
            <div class="content-side">
              <h3 class="intro-title">${title}</h3>
              <p class="intro-description">${description}</p>
            </div>
          </div>
        `;
      }

      // Configure dashboard visibility
      const dashboardBtn = document.getElementById("dashboard-btn");
      const mobileMenuBtn = document.getElementById("mobile-menu-btn");
      if (mobileMenuBtn && isMobileDevice()) {
        mobileMenuBtn.click();
      }
      if (dashboardBtn) {
        dashboardBtn.click();
      }

      const advancedUserSteps = [
        {
          id: "my-stats-btn",
          attachTo: {
            element: "#my-stats-btn",
            on: "right",
          },
          text: createIntroContent(
            "My Statistics",
            "Your personal performance dashboard. Track your response times, conversion rates, and other key metrics that matter. Consider it your practice's vital signs – because you can't improve what you don't measure."
          ),
        },
        {
          id: "c-metrics-button",
          attachTo: {
            element: "#c-metrics-button",
            on: "right",
          },
          text: createIntroContent(
            "Competitive Metrics",
            "Where you see how you measure up against opposing counsel (on the platform, that is). Consider this your performance review against the competition. Nothing motivates quite like seeing exactly where you rank in the pecking order. Time to raise the bar."
          ),
        },
        {
          id: "my-messages-btn",
          attachTo: {
            element: "#my-messages-btn",
            on: "right",
          },
          text: createIntroContent(
            "My Messages",
            "Where potential clients become actual clients. This is your direct line to every lead – respond promptly, professionally, and persuasively. Think of each message as a mini consultation. First responses make lasting impressions, so make them count."
          ),
        },
        {
          id: "profile-btn",
          attachTo: {
            element: "#profile-btn",
            on: "right",
          },
          text: createIntroContent(
            "Profile Settings Page",
            "Your profile settings – think of it as your opening statement to potential clients. This is where leads play judge and jury, deciding which lawyer to call. Make your case compelling: the more detail you provide, the stronger your appeal. Consider it due diligence for your own practice."
          ),
        },
        {
          id: "feedback-section",
          attachTo: {
            element: "#feedback-section",
            on: "left",
          },
          text: createIntroContent(
            "Feedback",
            "Where your objections and observations help shape our case. We're in beta, which means your input isn't just welcome – it's critical evidence. Spotted a bug? Found an error? Have a suggestion? File it here. Consider yourself co-counsel in building a better platform. We review every submission like it's a Supreme Court brief."
          ),
        },
        {
          id: "ai-rec-section",
          attachTo: {
            element: "#ai-rec-section",
            on: "top",
          },
          text: createIntroContent(
            "AI Recommendations",
            "Your personalized practice improvement plan, refreshed every 5 days. Our AI reviews your profile like opposing counsel would – finding every gap and weak point. Complete these suggestions to boost your profile strength score and completion percentage. Note: changes won't reflect immediately; think of it as a 5-day review period. The higher your score, the more compelling your case to potential clients."
          ),
        },
        {
          id: "ai-bot-btn",
          attachTo: {
            element: "#ai-bot-btn",
            on: "left",
          },
          text: createIntroContent(
            "AI Assistant",
            "Your digital associate, minus the billable hours. While it can't access your dashboard data, it can guide you through platform features, draft documents, brainstorm strategies, or answer virtually any question. Think of it as having a knowledgeable colleague on call 24/7 – one who never takes vacation or needs coffee. From contract templates to case law queries, just ask."
          ),
        },
      ];

      const advancedMobileUserSteps = [
        {
          id: "stats-menu-list",
          attachTo: {
            element: "#stats-menu-list",
          },
          text: createIntroContent(
            "My Statistics",
            "Your personal performance dashboard. Track your response times, conversion rates, and other key metrics that matter. Consider it your practice's vital signs – because you can't improve what you don't measure."
          ),
        },
        {
          id: "feedback-section",
          attachTo: {
            element: "#feedback-section",
          },
          text: createIntroContent(
            "Feedback",
            "Where your objections and observations help shape our case. We're in beta, which means your input isn't just welcome – it's critical evidence. Spotted a bug? Found an error? Have a suggestion? File it here. Consider yourself co-counsel in building a better platform. We review every submission like it's a Supreme Court brief."
          ),
        },
        {
          id: "my-messages-btn",
          attachTo: {
            element: "#my-messages-btn",
          },
          text: createIntroContent(
            "My Messages",
            "Where potential clients become actual clients. This is your direct line to every lead – respond promptly, professionally, and persuasively. Think of each message as a mini consultation. First responses make lasting impressions, so make them count."
          ),
          when: {
            show: () => {
              return new Promise((resolve) => {
                const mobileMenuBtn =
                  document.getElementById("mobile-menu-btn");
                if (mobileMenuBtn) {
                  mobileMenuBtn.click();
                  // Give the menu time to open before proceeding
                  setTimeout(() => {
                    resolve();
                  }, 500); // 500ms delay to allow menu animation
                } else {
                  resolve();
                }
              });
            },
          },
        },
        {
          id: "ai-rec-section",
          attachTo: {
            element: "#ai-rec-section",
          },
          text: createIntroContent(
            "AI Recommendations",
            "Your personalized practice improvement plan, refreshed every 5 days. Our AI reviews your profile like opposing counsel would – finding every gap and weak point. Complete these suggestions to boost your profile strength score and completion percentage. Note: changes won't reflect immediately; think of it as a 5-day review period. The higher your score, the more compelling your case to potential clients."
          ),
          when: {
            show: () => {
              const mobileMenuBtn = document.getElementById("mobile-menu-btn");
              if (mobileMenuBtn) {
                mobileMenuBtn.click();
              }
            },
          },
        },
        {
          id: "profile-btn",
          attachTo: {
            element: "#profile-btn",
          },
          text: createIntroContent(
            "Profile Settings Page",
            "Your profile settings – think of it as your opening statement to potential clients. This is where leads play judge and jury, deciding which lawyer to call. Make your case compelling: the more detail you provide, the stronger your appeal. Consider it due diligence for your own practice."
          ),
        },
        {
          id: "ai-bot-btn",
          attachTo: {
            element: "#ai-bot-btn",
          },
          text: createIntroContent(
            "AI Assistant",
            "Your digital associate, minus the billable hours. While it can't access your dashboard data, it can guide you through platform features, draft documents, brainstorm strategies, or answer virtually any question. Think of it as having a knowledgeable colleague on call 24/7 – one who never takes vacation or needs coffee. From contract templates to case law queries, just ask."
          ),
        },
      ];

      const essentialUserSteps = [
        {
          id: "my-stats-btn-locked",
          attachTo: {
            element: "#my-stats-btn-locked",
            on: "right",
          },
          text: createIntroContent(
            "My Stats",
            "Your personal performance dashboard. Track your response times, conversion rates, and other key metrics that matter. Consider it your practice's vital signs – because you can't improve what you don't measure. Time to see the evidence of your efforts."
          ),
        },
        {
          id: "c-metrics-button-locked",
          attachTo: {
            element: "#c-metrics-button-locked",
            on: "right",
          },
          text: createIntroContent(
            "Competitive Metrics",
            "Where you see how you measure up against opposing counsel (on the platform, that is). Consider this your performance review against the competition. Nothing motivates quite like seeing exactly where you rank in the pecking order. Time to raise the bar."
          ),
        },
        {
          id: "my-messages-btn",
          attachTo: {
            element: "#my-messages-btn",
            on: "right",
          },
          text: createIntroContent(
            "My Messages",
            "Where potential clients become actual clients. This is your direct line to every lead – respond promptly, professionally, and persuasively. Think of each message as a mini consultation. First responses make lasting impressions, so make them count."
          ),
        },
        {
          id: "profile-btn",
          attachTo: {
            element: "#profile-btn",
            on: "right",
          },
          text: createIntroContent(
            "Profile Settings Page",
            "Your profile settings – think of it as your opening statement to potential clients. This is where leads play judge and jury, deciding which lawyer to call. Make your case compelling: the more detail you provide, the stronger your appeal. Consider it due diligence for your own practice."
          ),
        },
        {
          id: "feedback-section",
          attachTo: {
            element: "#feedback-section",
            on: "left",
          },
          text: createIntroContent(
            "Feedback",
            "Where your objections and observations help shape our case. We're in beta, which means your input isn't just welcome – it's critical evidence. Spotted a bug? Found an error? Have a suggestion? File it here. Consider yourself co-counsel in building a better platform. We review every submission like it's a Supreme Court brief."
          ),
        },
        {
          id: "locked-ai-rec",
          attachTo: {
            element: "#locked-ai-rec",
            on: "top",
          },
          text: createIntroContent(
            "AI Recommendations",
            "Your personalized practice improvement plan, refreshed every 5 days. Our AI reviews your profile like opposing counsel would – finding every gap and weak point. Complete these suggestions to boost your profile strength score and completion percentage. Note: changes won't reflect immediately; think of it as a 5-day review period. The higher your score, the more compelling your case to potential clients."
          ),
        },
        {
          id: "ai-bot-btn",
          attachTo: {
            element: "#ai-bot-btn",
            on: "left",
          },
          text: createIntroContent(
            "AI Assistant",
            "Your digital associate, minus the billable hours. While it can't access your dashboard data, it can guide you through platform features, draft documents, brainstorm strategies, or answer virtually any question. Think of it as having a knowledgeable colleague on call 24/7 – one who never takes vacation or needs coffee. From contract templates to case law queries, just ask."
          ),
        },
      ];

      const essentialMobileUserSteps = [
        {
          id: "my-stats-btn-locked",
          attachTo: {
            element: "#my-stats-btn-locked",
            on: "right",
          },
          text: createIntroContent(
            "My Stats",
            "Your personal performance dashboard. Track your response times, conversion rates, and other key metrics that matter. Consider it your practice's vital signs – because you can't improve what you don't measure. Time to see the evidence of your efforts."
          ),
        },
        {
          id: "c-metrics-button-locked",
          attachTo: {
            element: "#c-metrics-button-locked",
            on: "right",
          },
          text: createIntroContent(
            "Competitive Metrics",
            "Where you see how you measure up against opposing counsel (on the platform, that is). Consider this your performance review against the competition. Nothing motivates quite like seeing exactly where you rank in the pecking order. Time to raise the bar."
          ),
        },
        {
          id: "my-messages-btn",
          attachTo: {
            element: "#my-messages-btn",
            on: "right",
          },
          text: createIntroContent(
            "My Messages",
            "Where potential clients become actual clients. This is your direct line to every lead – respond promptly, professionally, and persuasively. Think of each message as a mini consultation. First responses make lasting impressions, so make them count."
          ),
        },
        {
          id: "profile-btn",
          attachTo: {
            element: "#profile-btn",
            on: "right",
          },
          text: createIntroContent(
            "Profile Settings Page",
            "Your profile settings – think of it as your opening statement to potential clients. This is where leads play judge and jury, deciding which lawyer to call. Make your case compelling: the more detail you provide, the stronger your appeal. Consider it due diligence for your own practice."
          ),
        },
        {
          id: "feedback-section",
          attachTo: {
            element: "#feedback-section",
            on: "left",
          },
          text: createIntroContent(
            "Feedback",
            "Where your objections and observations help shape our case. We're in beta, which means your input isn't just welcome – it's critical evidence. Spotted a bug? Found an error? Have a suggestion? File it here. Consider yourself co-counsel in building a better platform. We review every submission like it's a Supreme Court brief."
          ),
        },
        {
          id: "locked-ai-rec",
          attachTo: {
            element: "#locked-ai-rec",
            on: "left",
          },
          text: createIntroContent(
            "AI Recommendations",
            "Your personalized practice improvement plan, refreshed every 5 days. Our AI reviews your profile like opposing counsel would – finding every gap and weak point. Complete these suggestions to boost your profile strength score and completion percentage. Note: changes won't reflect immediately; think of it as a 5-day review period. The higher your score, the more compelling your case to potential clients."
          ),
        },
      ];

      // Shepherd.js tour instance
      const tour = new Shepherd.Tour({
        defaultStepOptions: {
          cancelIcon: {
            enabled: true,
          },
          classes: "custom-shepherd-tooltip",
          scrollTo: { behavior: "smooth", block: "center" },
          canClickTarget: false,
          modalOverlayOpeningPadding: 5,
        },
        useModalOverlay: true,
        // Control where steps are injected - useful for mobile layouts
        stepsContainer: isMobileDevice()
          ? document.querySelector(
              ".w-nav-overlay .slidebar4-menu-container"
            ) || document.body
          : document.body,
        // Control where modal overlay is injected
        // modalContainer: isMobileDevice()
        //   ? document.getElementById("mobile-modal-container") || document.body
        //   : document.body,
      });

      // Function to initialize Lottie animation in Shepherd step
      function initializeLottieAnimationShepherd() {
        const lottieContainer = document.querySelector(
          ".shepherd-element .intro-lottie-container"
        );
        if (
          lottieContainer &&
          typeof lottie !== "undefined" &&
          lottieAnimationData
        ) {
          try {
            lottieContainer.innerHTML = "";
            lottie.loadAnimation({
              container: lottieContainer,
              renderer: "svg",
              loop: true,
              autoplay: true,
              animationData: lottieAnimationData,
            });
          } catch (error) {
            console.error("Error creating Lottie animation:", error);
          }
        }
      }

      // Shepherd.js step creation helper
      function getStepWithLottie(step) {
        return {
          ...step,
          when: {
            show: () => {
              // Initialize Lottie animation after step is shown
              setTimeout(initializeLottieAnimationShepherd, 100);
            },
            ...step.when, // Merge any existing when handlers
          },
        };
      }

      // Set up Shepherd.js steps directly
      function setShepherdSteps(steps) {
        // Clear existing steps
        tour.steps = [];

        steps.forEach((step, idx) => {
          const shepherdStep = getStepWithLottie(step);

          // Add default buttons if not provided
          if (!shepherdStep.buttons) {
            shepherdStep.buttons = [];

            // Add Back button if not first step
            if (idx > 0) {
              shepherdStep.buttons.push({
                text: "Back",
                action() {
                  return this.back();
                },
                classes: "shepherd-button-secondary",
                secondary: true,
              });
            }

            // Add Next/Done button
            if (idx === steps.length - 1) {
              shepherdStep.buttons.push({
                text: "Done!",
                action() {
                  return this.complete();
                },
              });
            } else {
              shepherdStep.buttons.push({
                text: "Next",
                action() {
                  return this.next();
                },
              });
            }
          }

          tour.addStep(shepherdStep);
        });
      }

      // Shepherd.js tour completion handlers
      tour.on("complete", () => {
        console.log("Tour completed");
        if (typeof window.$memberstackDom !== "undefined") {
          window.$memberstackDom
            .getCurrentMember()
            .then(function ({ data: member }) {
              if (member) {
                return window.$memberstackDom.updateMemberJSON({
                  hasLoggedInBefore: true,
                });
              }
            })
            .then(function () {
              console.log("Updated hasLoggedInBefore to true");
            })
            .catch(function (error) {
              console.error("Error updating member JSON:", error);
            });
        }
      });

      tour.on("cancel", () => {
        console.log("Tour cancelled");
        if (typeof window.$memberstackDom !== "undefined") {
          window.$memberstackDom
            .getCurrentMember()
            .then(function ({ data: member }) {
              if (member) {
                return window.$memberstackDom.updateMemberJSON({
                  hasLoggedInBefore: true,
                });
              }
            })
            .then(function () {
              console.log("Updated hasLoggedInBefore to true");
            })
            .catch(function (error) {
              console.error("Error updating member JSON:", error);
            });
        }
      });

      // Initialize the tour based on membership level
      try {
        if (typeof window.$memberstackDom !== "undefined") {
          window.$memberstackDom
            .getCurrentMember()
            .then(function ({ data: member }) {
              if (member) {
                const membershipPlan = member.planConnections[0];
                if (membershipPlan) {
                  const membershipPlanId = membershipPlan.planId;
                  const advancedMembershipPlanIds = [
                    "pln_lawggle-advanced-v2-r74e0sgz",
                    "pln_lawggle-advanced-v2-a6t0erf",
                  ];

                  if (advancedMembershipPlanIds.includes(membershipPlanId)) {
                    if (isMobileDevice()) {
                      setShepherdSteps(advancedMobileUserSteps);
                    } else {
                      setShepherdSteps(advancedUserSteps);
                    }
                  } else {
                    if (isMobileDevice()) {
                      setShepherdSteps(essentialMobileUserSteps);
                    } else {
                      setShepherdSteps(essentialUserSteps);
                    }
                  }

                  // Start the tour after a delay
                  setTimeout(() => {
                    tour.start();
                  }, 4000);
                }
              }
            })
            .catch(function (error) {
              console.error("Error retrieving MemberStack member:", error);
              // Fallback to essential steps on error
              if (isMobileDevice()) {
                setShepherdSteps(essentialMobileUserSteps);
              } else {
                setShepherdSteps(essentialUserSteps);
              }
              setTimeout(() => {
                tour.start();
              }, 4000);
            });
        } else {
          // Fallback when MemberStack is not available
          console.log("MemberStack not available, using essential steps");
          if (isMobileDevice()) {
            setShepherdSteps(essentialMobileUserSteps);
          } else {
            setShepherdSteps(essentialUserSteps);
          }
          setTimeout(() => {
            tour.start();
          }, 4000);
        }
      } catch (error) {
        console.error("Error in MemberStack membership check:", error);
        // Fallback on any error
        if (isMobileDevice()) {
          setShepherdSteps(essentialMobileUserSteps);
        } else {
          setShepherdSteps(essentialUserSteps);
        }
        setTimeout(() => {
          tour.start();
        }, 4000);
      }

      // ...existing code...
    }); // End of checkIfShouldRunTour().then()
  });

  function isMobileDevice() {
    return window.innerWidth <= 768;
  }
</script>
