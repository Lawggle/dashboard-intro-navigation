<style>
  .introjs-tooltipReferenceLayer {
    font-family: inherit;
  }
  .introjs-tooltip {
    min-width: 600px;
    background-color: #ffe0b6;
    box-shadow: 0px 4px 32px -4px #ffe0b6;
  }

  @media (max-width: 768px) {
    .introjs-tooltip {
      min-width: 90vw;
      margin: 0 auto;
    }

    /* Force bottom positioning on mobile */
    .introjs-tooltip.introjs-bottom {
      position: fixed !important;
      bottom: 20px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      top: auto !important;
    }

    /* Adjust arrow for bottom positioning */
    .introjs-arrow.bottom {
      display: none !important; /* Hide arrow on mobile for cleaner look */
    }

    /* Special handling for feedback section on mobile */
    .introjs-tooltip[data-step-element="#feedback-section"] {
      position: fixed !important;
      bottom: 20px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      top: auto !important;
    }

    .introjs-tooltip[data-step-element="#feedback-section"] .introjs-arrow {
      display: block !important;
      border-top-color: #ffe0b6 !important;
    }

    /* Make tooltip content more mobile-friendly */
    .custom-intro-content {
      flex-direction: row;
      text-align: left;
      gap: 10px;
      align-items: flex-start;
    }

    .intro-image-container {
      width: 90px;
      height: auto;
      margin: 0;
      flex-shrink: 0;
    }
  }
  .introjs-tooltiptext {
    padding: 10px 20px;
  }
  .custom-intro-content {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  /* Image container enhancements */
  .intro-image-container {
    width: 150px;
    height: auto;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    transform: scale(1);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    border-radius: 8px;
  }

  .intro-step-image {
    width: 150px;
    height: auto;
    object-fit: contain;
    border-radius: 6px;
  }

  .intro-image-container.animate-in {
    animation: imageSlideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  @keyframes imageSlideIn {
    0% {
      transform: scale(0.8) translateY(20px);
      opacity: 0;
    }
    50% {
      transform: scale(1.05) translateY(5px);
      opacity: 0.8;
    }
    100% {
      transform: scale(1) translateY(0);
      opacity: 1;
    }
  }

  @media (max-width: 768px) {
    .intro-image-container {
      width: 90px;
      height: auto;
    }

    .intro-step-image {
      width: 90px;
      height: auto;
    }
  }
  .introjs-arrow.right {
    border-left-color: #ffe0b6 !important;
  }

  .introjs-arrow.left {
    border-right-color: #ffe0b6 !important;
  }
  .introjs-arrow.top {
    border-bottom-color: #ffe0b6 !important;
  }
  .introjs-arrow.bottom {
    border-top-color: #ffe0b6 !important;
  }
  .introjs-tooltip-title {
    display: none;
  }
  .introjs-helperNumberLayer {
    position: absolute;
    left: 10px;
    padding-top: 15px;
    color: #1f1f1f;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    animation: stepNumberBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }

  @keyframes stepNumberBounce {
    0% {
      transform: scale(0.3) rotate(-12deg);
      opacity: 0;
    }
    50% {
      transform: scale(1.1) rotate(0deg);
      opacity: 0.8;
    }
    100% {
      transform: scale(1) rotate(0deg);
      opacity: 1;
    }
  }

  @media (max-width: 768px) {
    .introjs-helperNumberLayer {
      font-size: 12px;
      padding-top: 10px;
    }
  }

  .introjs-tooltipbuttons {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    border-color: #514f6e26;
  }

  @media (max-width: 768px) {
    .introjs-tooltipbuttons {
      padding: 6px;
    }
  }

  .introjs-button {
    padding: 3px 2px;
    border: none !important;
    outline: none !important;
    background-color: #ffe0b6;
    font-weight: 600;
    position: relative;
    box-shadow: none !important;
  }
  .introjs-button:hover {
    background-color: #ffe0b6;
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
  }
  .introjs-button:focus {
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
    background-color: #ffe0b6;
  }
  .introjs-button:active {
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
    background-color: #ffe0b6;
  }
  .introjs-disabled {
    color: #b9b9b9;
  }

  /* 
  .introjs-button.introjs-prevbutton::after {
    content: "";
    position: absolute;
    height: 100%;
    width: 0.9px;
    background-color: #514f6e;
    right: -6px;
    top: 0;
  } */
  .intro-title {
    padding-bottom: 10px;
  }

  @media (max-width: 768px) {
    .intro-title {
      padding-bottom: 0px;
      font-size: 16px;
      text-align: left;
    }
  }

  .intro-description {
    line-height: 1.5;
    color: #1f1f1f;
    font-weight: 400;
  }

  /* Combined intro content styling */
  .combined-intro-section {
    margin-bottom: 20px;
  }

  .combined-intro-section:last-child {
    margin-bottom: 0;
  }

  .intro-divider {
    margin: 15px 0;
    border: none;
    border-top: 1px solid #ddd;
    opacity: 0.6;
  }

  @media (max-width: 768px) {
    .intro-description {
      font-size: 10px;
      line-height: 1.2;
      text-align: left;
    }

    .intro-divider {
      margin: 10px 0;
    }
  }

  /* Modern step transition animations - Fixed for smooth experience */
  .introjs-tooltip {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: scale(1);
    opacity: 1;
    will-change: transform, opacity;
  }

  /* Simplified entrance animation */
  .introjs-tooltip.entering {
    transform: scale(0.95) translateY(10px);
    opacity: 0;
  }

  .introjs-tooltip.entered {
    transform: scale(1) translateY(0);
    opacity: 1;
  }

  /* Smooth highlight transitions */
  .introjs-helperLayer {
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform;
  }

  /* Synchronized content and background animation */
  .custom-intro-content {
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: opacity, transform;
  }

  .introjs-tooltip.entering .custom-intro-content {
    opacity: 0;
    transform: translateY(8px);
  }

  .introjs-tooltip.entered .custom-intro-content {
    opacity: 1;
    transform: translateY(0);
  }

  /* Modern button hover effects */
  .introjs-button {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateY(0);
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
    will-change: transform, box-shadow;
  }

  .introjs-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    border: none !important;
    outline: none !important;
  }

  .introjs-button:active {
    transform: translateY(0);
    transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
  }

  .introjs-button:focus {
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
  }

  /* Enhanced next button styling */
  .introjs-button.introjs-nextbutton:focus,
  .introjs-button.introjs-nextbutton:hover {
    background-color: #ffe0b6 !important;
    transform: translateY(-1px) scale(1.01);
    box-shadow: 0 2px 8px rgba(255, 216, 155, 0.3) !important;
    font-weight: 700;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .introjs-button.introjs-nextbutton:active {
    background-color: #ffe0b6 !important;
    transform: translateY(0) scale(1);
    box-shadow: 0 1px 4px rgba(255, 216, 155, 0.2) !important;
    transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Enhanced previous button styling to match next button */
  .introjs-button.introjs-prevbutton:focus,
  .introjs-button.introjs-prevbutton:hover {
    background-color: #ffe0b6 !important;
    transform: translateY(-1px) scale(1.01);
    box-shadow: 0 2px 8px rgba(255, 216, 155, 0.3) !important;
    font-weight: 700;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .introjs-button.introjs-prevbutton:active {
    background-color: #ffe0b6 !important;
    transform: translateY(0) scale(1);
    box-shadow: 0 1px 4px rgba(255, 216, 155, 0.2) !important;
    transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Modern progress and overlay transitions */
  .introjs-progress {
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .introjs-overlay {
    transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Ensure tooltip content can scroll if needed */
  .introjs-tooltiptext {
    overflow-y: auto !important;
    max-height: 70vh !important;
  }

  .introjs-tooltip-header {
    display: none;
  }

  .introjs-tooltiptext {
    padding-top: 10px;
  }

  @media (min-width: 1024px) {
    .introjs-tooltiptext {
      padding-top: 15px;
    }
  }
</style>

<script>
  // Wait for page to load
  document.addEventListener("DOMContentLoaded", function () {
    // Check if user has already seen the tour
    async function checkIfShouldRunTour() {
      try {
        if (typeof window.$memberstackDom !== "undefined") {
          const { data: member } =
            await window.$memberstackDom.getCurrentMember();

          if (member) {
            const memberJson = await window.$memberstackDom.getMemberJSON();

            // Only run tour if hasLoggedInBefore is null, undefined, or false
            if (memberJson.data.hasLoggedInBefore === true) {
              console.log("User has already seen the tour, skipping...");
              return false;
            }
          }
        }
        return true; // Run tour for new users or when memberstack is not available
      } catch (error) {
        console.error("Error checking tour status:", error);
        return true; // Run tour on error to be safe
      }
    }

    // Initialize tour only if conditions are met
    checkIfShouldRunTour().then((shouldRun) => {
      console.log("üé≠ Tour should run:", shouldRun);
      if (!shouldRun) {
        console.log("‚ùå Tour cancelled - user has already seen it");
        return;
      }

      console.log("‚úÖ Initializing tour for new user");

      // Define images for each step
      const stepImages = {
        "my-stats":
          "https://cdn.prod.website-files.com/67e360f08a15ef65d8814b41/688e4035f058589e135b8874_Stats%20page.png",
        "competitive-metrics":
          "https://cdn.prod.website-files.com/67e360f08a15ef65d8814b41/688f7ee00d7d3716ec0065c5_competetive%20metrics-croped.png",
        messages:
          "https://cdn.prod.website-files.com/67e360f08a15ef65d8814b41/688e4033961d84e358819cb2_my%20messages.png",
        profile:
          "https://cdn.prod.website-files.com/67e360f08a15ef65d8814b41/688f7ee0927aeb9c32ab95d0_Profile%20Page-croped.png",
        feedback:
          "https://cdn.prod.website-files.com/67e360f08a15ef65d8814b41/688f7ee0a6dad7659ee4eba9_feedback-croped.png",
        "ai-recommendations":
          "https://cdn.prod.website-files.com/67e360f08a15ef65d8814b41/688f8097a1a40ca73fb2b700_ai%20recommendations-croped2.png",
        "ai-assistant":
          "https://cdn.prod.website-files.com/67e360f08a15ef65d8814b41/688e4035a43ec70b8fa34d43_AI%20assistant.png",
      };

      // Helper function to create intro content with image
      function createIntroContent(title, description, imageKey) {
        return `
          <div class="custom-intro-content">
            <div class="image-side">
              <div class="intro-image-container">
                <img src="${stepImages[imageKey]}" alt="${title}" class="intro-step-image" />
              </div>
            </div>
            <div class="content-side">
              <h3 class="intro-title">${title}</h3>
              <p class="intro-description">${description}</p>
            </div>
          </div>
        `;
      }

      // Helper function to create combined intro content for multiple sections
      function createCombinedIntroContent(sections) {
        const sectionsHtml = sections
          .map(
            (section) => `
          <div class="custom-intro-content">
            <div class="image-side">
              <div class="intro-image-container">
                <img src="${stepImages[section.imageKey]}" alt="${
              section.title
            }" class="intro-step-image" />
              </div>
            </div>
            <div class="content-side">
              <h3 class="intro-title">${section.title}</h3>
              <p class="intro-description">${section.description}</p>
            </div>
          </div>
        `
          )
          .join(
            '<hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">'
          );

        return sectionsHtml;
      }

      // Configure intro.js options
      const dashboardBtn = document.getElementById("dashboard-btn");
      // const mobileMenuBtn = document.getElementById("mobile-menu-btn");
      // if (mobileMenuBtn && isMobileDevice()) {
      //   mobileMenuBtn.click();
      // }
      if (dashboardBtn) {
        dashboardBtn.click();
      }

      const advancedUserSteps = [
        {
          element: "#my-stats-btn",
          intro: createIntroContent(
            "My Statistics",
            "Your personal performance dashboard. Track your response times, conversion rates, and other key metrics that matter. Consider it your practice's vital signs ‚Äì because you can't improve what you don't measure.",
            "my-stats"
          ),
          position: "right",
        },
        {
          element: "#c-metrics-button",
          intro: createIntroContent(
            "Competitive Metrics",
            "Where you see how you measure up against opposing counsel (on the platform, that is). Consider this your performance review against the competition. Nothing motivates quite like seeing exactly where you rank in the pecking order. Time to raise the bar.",
            "competitive-metrics"
          ),
          position: "right",
        },
        {
          element: "#my-messages-btn",
          intro: createIntroContent(
            "My Messages",
            "Where potential clients become actual clients. This is your direct line to every lead ‚Äì respond promptly, professionally, and persuasively. Think of each message as a mini consultation. First responses make lasting impressions, so make them count.",
            "messages"
          ),
          position: "right",
        },
        {
          element: "#profile-btn",
          intro: createIntroContent(
            "Profile Settings Page",
            "Your profile settings ‚Äì think of it as your opening statement to potential clients. This is where leads play judge and jury, deciding which lawyer to call. Make your case compelling: the more detail you provide, the stronger your appeal. Consider it due diligence for your own practice.",
            "profile"
          ),
          position: "right",
        },
        {
          element: "#feedback-section",
          intro: createIntroContent(
            "Feedback",
            "Where your objections and observations help shape our case. We're in beta, which means your input isn't just welcome ‚Äì it's critical evidence. Spotted a bug? Found an error? Have a suggestion? File it here. Consider yourself co-counsel in building a better platform. We review every submission like it's a Supreme Court brief.",
            "feedback"
          ),
          position: "left",
        },
        {
          element: "#ai-rec-section",
          intro: createIntroContent(
            "AI Recommendations",
            "Your personalized practice improvement plan, refreshed every 5 days. Our AI reviews your profile like opposing counsel would ‚Äì finding every gap and weak point. Complete these suggestions to boost your profile strength score and completion percentage. Note: changes won't reflect immediately; think of it as a 5-day review period. The higher your score, the more compelling your case to potential clients.",
            "ai-recommendations"
          ),
          position: "top",
        },
        {
          element: "#ai-bot-btn",
          intro: createIntroContent(
            "AI Assistant",
            "Your digital associate, minus the billable hours. While it can't access your dashboard data, it can guide you through platform features, draft documents, brainstorm strategies, or answer virtually any question. Think of it as having a knowledgeable colleague on call 24/7 ‚Äì one who never takes vacation or needs coffee. From contract templates to case law queries, just ask.",
            "ai-assistant"
          ),
          position: "top",
        },
      ];

      const advancedMobileUserSteps = [
        {
          element: "#stats-menu-list",
          intro: createCombinedIntroContent([
            {
              title: "My Statistics",
              description:
                "Your personal performance dashboard. Track your response times, conversion rates, and other key metrics that matter. Consider it your practice's vital signs ‚Äì because you can't improve what you don't measure.",
              imageKey: "my-stats",
            },
            {
              title: "Competitive Metrics",
              description:
                "Where you see how you measure up against opposing counsel (on the platform, that is). Consider this your performance review against the competition. Nothing motivates quite like seeing exactly where you rank in the pecking order. Time to raise the bar.",
              imageKey: "competitive-metrics",
            },
          ]),
          position: "bottom",
        },
        {
          element: "#feedback-section",
          intro: createIntroContent(
            "Feedback",
            "Where your objections and observations help shape our case. We're in beta, which means your input isn't just welcome ‚Äì it's critical evidence. Spotted a bug? Found an error? Have a suggestion? File it here. Consider yourself co-counsel in building a better platform. We review every submission like it's a Supreme Court brief.",
            "feedback"
          ),
          position: "bottom",
          scrollTo: "tooltip",
          disableInteraction: true,
        },
        {
          element: "#my-messages-btn",
          intro: createIntroContent(
            "My Messages",
            "Where potential clients become actual clients. This is your direct line to every lead ‚Äì respond promptly, professionally, and persuasively. Think of each message as a mini consultation. First responses make lasting impressions, so make them count.",
            "messages"
          ),
          position: "bottom",
        },
        {
          element: "#ai-rec-section",
          intro: createIntroContent(
            "AI Recommendations",
            "Your personalized practice improvement plan, refreshed every 5 days. Our AI reviews your profile like opposing counsel would ‚Äì finding every gap and weak point. Complete these suggestions to boost your profile strength score and completion percentage. Note: changes won't reflect immediately; think of it as a 5-day review period. The higher your score, the more compelling your case to potential clients.",
            "ai-recommendations"
          ),
          position: "top",
          scrollTo: "tooltip",
          disableInteraction: true,
        },
        {
          element: "#profile-btn",
          intro: createIntroContent(
            "Profile Settings Page",
            "Your profile settings ‚Äì think of it as your opening statement to potential clients. This is where leads play judge and jury, deciding which lawyer to call. Make your case compelling: the more detail you provide, the stronger your appeal. Consider it due diligence for your own practice.",
            "profile"
          ),
          position: "bottom",
        },
        {
          element: "#ai-bot-btn",
          intro: createIntroContent(
            "AI Assistant",
            "Your digital associate, minus the billable hours. While it can't access your dashboard data, it can guide you through platform features, draft documents, brainstorm strategies, or answer virtually any question. Think of it as having a knowledgeable colleague on call 24/7 ‚Äì one who never takes vacation or needs coffee. From contract templates to case law queries, just ask.",
            "ai-assistant"
          ),
          position: "left",
        },
      ];

      const essentialUserSteps = [
        {
          element: "#my-stats-btn-locked",
          intro: createIntroContent(
            "My Stats",
            "Your personal performance dashboard. Track your response times, conversion rates, and other key metrics that matter. Consider it your practice's vital signs ‚Äì because you can't improve what you don't measure. Time to see the evidence of your efforts.",
            "my-stats"
          ),
          position: "right",
        },
        {
          element: "#c-metrics-button-locked",
          intro: createIntroContent(
            "Competitive Metrics",
            "Where you see how you measure up against opposing counsel (on the platform, that is). Consider this your performance review against the competition. Nothing motivates quite like seeing exactly where you rank in the pecking order. Time to raise the bar.",
            "competitive-metrics"
          ),
          position: "right",
        },
        {
          element: "#my-messages-btn",
          intro: createIntroContent(
            "My Messages",
            "Where potential clients become actual clients. This is your direct line to every lead ‚Äì respond promptly, professionally, and persuasively. Think of each message as a mini consultation. First responses make lasting impressions, so make them count.",
            "messages"
          ),
          position: "right",
        },
        {
          element: "#profile-btn",
          intro: createIntroContent(
            "Profile Settings Page",
            "Your profile settings ‚Äì think of it as your opening statement to potential clients. This is where leads play judge and jury, deciding which lawyer to call. Make your case compelling: the more detail you provide, the stronger your appeal. Consider it due diligence for your own practice.",
            "profile"
          ),
          position: "right",
        },
        {
          element: "#feedback-section",
          intro: createIntroContent(
            "Feedback",
            "Where your objections and observations help shape our case. We're in beta, which means your input isn't just welcome ‚Äì it's critical evidence. Spotted a bug? Found an error? Have a suggestion? File it here. Consider yourself co-counsel in building a better platform. We review every submission like it's a Supreme Court brief.",
            "feedback"
          ),
          position: "bottom",
        },
        {
          element: "#locked-ai-rec",
          intro: createIntroContent(
            "AI Recommendations",
            "Your personalized practice improvement plan, refreshed every 5 days. Our AI reviews your profile like opposing counsel would ‚Äì finding every gap and weak point. Complete these suggestions to boost your profile strength score and completion percentage. Note: changes won't reflect immediately; think of it as a 5-day review period. The higher your score, the more compelling your case to potential clients.",
            "ai-recommendations"
          ),
          position: "top",
        },
        {
          element: "#ai-bot-btn",
          intro: createIntroContent(
            "AI Assistant",
            "Your digital associate, minus the billable hours. While it can't access your dashboard data, it can guide you through platform features, draft documents, brainstorm strategies, or answer virtually any question. Think of it as having a knowledgeable colleague on call 24/7 ‚Äì one who never takes vacation or needs coffee. From contract templates to case law queries, just ask.",
            "ai-assistant"
          ),
          position: "top",
        },
      ];

      const essentialMobileUserSteps = [
        {
          element: "#stats-menu-list",
          intro: createCombinedIntroContent([
            {
              title: "My Statistics",
              description:
                "Your personal performance dashboard. Track your response times, conversion rates, and other key metrics that matter. Consider it your practice's vital signs ‚Äì because you can't improve what you don't measure.",
              imageKey: "my-stats",
            },
            {
              title: "Competitive Metrics",
              description:
                "Where you see how you measure up against opposing counsel (on the platform, that is). Consider this your performance review against the competition. Nothing motivates quite like seeing exactly where you rank in the pecking order. Time to raise the bar.",
              imageKey: "competitive-metrics",
            },
          ]),
          position: "bottom",
        },
        {
          element: "#feedback-section",
          intro: createIntroContent(
            "Feedback",
            "Where your objections and observations help shape our case. We're in beta, which means your input isn't just welcome ‚Äì it's critical evidence. Spotted a bug? Found an error? Have a suggestion? File it here. Consider yourself co-counsel in building a better platform. We review every submission like it's a Supreme Court brief.",
            "feedback"
          ),
          position: "top",
        },
        {
          element: "#my-messages-btn",
          intro: createIntroContent(
            "My Messages",
            "Where potential clients become actual clients. This is your direct line to every lead ‚Äì respond promptly, professionally, and persuasively. Think of each message as a mini consultation. First responses make lasting impressions, so make them count.",
            "messages"
          ),
          position: "bottom",
        },
        {
          element: "#locked-ai-rec",
          intro: createIntroContent(
            "AI Recommendations",
            // beforeStep removed; logic moved to onbeforechange
            "Your profile settings ‚Äì think of it as your opening statement to potential clients. This is where leads play judge and jury, deciding which lawyer to call. Make your case compelling: the more detail you provide, the stronger your appeal. Consider it due diligence for your own practice.",
            "ai-recommendations"
          ),
          position: "top",
          beforeStep: () => {
            // Ensure feedback section is visible
            const mobileMenuBtn = document.getElementById("mobile-menu-btn");
            if (mobileMenuBtn) {
              mobileMenuBtn.click();
            }
          },
        },
        {
          element: "#profile-btn",
          intro: createIntroContent(
            "Profile Settings Page",
            "Your profile settings ‚Äì think of it as your opening statement to potential clients. This is where leads play judge and jury, deciding which lawyer to call. Make your case compelling: the more detail you provide, the stronger your appeal. Consider it due diligence for your own practice.",
            "profile"
          ),
          position: "bottom",
        },
        {
          element: "#ai-bot-btn",
          intro: createIntroContent(
            "AI Assistant",
            "Your digital associate, minus the billable hours. While it can't access your dashboard data, it can guide you through platform features, draft documents, brainstorm strategies, or answer virtually any question. Think of it as having a knowledgeable colleague on call 24/7 ‚Äì one who never takes vacation or needs coffee. From contract templates to case law queries, just ask.",
            "ai-assistant"
          ),
          position: "left",
        },
      ];

      // Store the configured instance
      const intro = introJs().setOptions({
        nextLabel: "Next ‚Üí",
        prevLabel: "‚Üê Back",
        doneLabel: "Done!",
        showProgress: false,
        showBullets: false,
        exitOnOverlayClick: false,
        exitOnEsc: false,
        disableInteraction: true,
        showStepNumbers: true,
        stepNumbersOfLabel: "/",
        scrollPadding: 0,
        keyboardNavigation: false,
      });

      // Modern smooth step transition function
      function performSmoothStepTransition(callback) {
        const tooltip = document.querySelector(".introjs-tooltip");

        if (tooltip) {
          // Start exit animation
          tooltip.classList.add("entering");

          // Execute callback after exit animation
          setTimeout(() => {
            callback();

            // Initialize entrance animation for new step
            setTimeout(() => {
              const newTooltip = document.querySelector(".introjs-tooltip");
              if (newTooltip) {
                // Ensure entering state
                newTooltip.classList.add("entering");

                // Trigger entrance animation
                requestAnimationFrame(() => {
                  newTooltip.classList.remove("entering");
                  newTooltip.classList.add("entered");

                  // Clean up after animation
                  setTimeout(() => {
                    newTooltip.classList.remove("entered");
                  }, 300);
                });
              }
            }, 20);
          }, 300);
        } else {
          // Fallback if tooltip not found
          callback();
        }
      }

      // Override intro.js navigation for smooth transitions
      let isTransitioning = false;

      // Store original methods
      const originalNextStep = intro.nextStep;
      const originalPreviousStep = intro.previousStep;

      // Enhanced next step with smooth transition
      intro.nextStep = function () {
        if (isTransitioning) return;
        isTransitioning = true;

        performSmoothStepTransition(() => {
          originalNextStep.call(this);
          setTimeout(() => {
            isTransitioning = false;
            initializeStepImages();
          }, 100);
        });
      };

      // Enhanced previous step with smooth transition
      intro.previousStep = function () {
        if (isTransitioning) return;
        isTransitioning = true;

        performSmoothStepTransition(() => {
          originalPreviousStep.call(this);
          setTimeout(() => {
            isTransitioning = false;
            initializeStepImages();
          }, 100);
        });
      };

      // Function to initialize step images
      function initializeStepImages() {
        const imageContainers = document.querySelectorAll(
          ".introjs-tooltip .intro-image-container"
        );

        console.log("Image containers found:", imageContainers.length);

        if (imageContainers.length > 0) {
          imageContainers.forEach((imageContainer, index) => {
            try {
              // Add entrance animation class
              imageContainer.classList.add("animate-in");

              // Find the image inside the container
              const image = imageContainer.querySelector(".intro-step-image");
              if (image) {
                // Add loading event listener
                image.addEventListener("load", () => {
                  console.log(`Step image ${index + 1} loaded successfully`);
                });

                image.addEventListener("error", () => {
                  console.error(
                    `Error loading step image ${index + 1}:`,
                    image.src
                  );
                  // You can add a fallback image here if needed
                  // image.src = 'path/to/fallback-image.png';
                });
              }

              // Remove animation class after completion
              setTimeout(() => {
                imageContainer.classList.remove("animate-in");
              }, 600);

              console.log(`Step image ${index + 1} initialized successfully`);
            } catch (error) {
              console.error(
                `Error initializing step image ${index + 1}:`,
                error
              );
            }
          });
        } else {
          console.warn("No image containers found in current step");
        }
      }

      // Initialize step images for all steps - including first step
      intro.onbeforechange(function (targetElement) {
        // Prepare for smooth transition
        const tooltip = document.querySelector(".introjs-tooltip");
        if (tooltip) {
          tooltip.classList.remove("entered");
        }

        // Return true to allow step change
        return true;
      });

      // Handle mobile menu opening when we reach specific steps
      intro.onafterchange(function (targetElement) {
        const currentStepIndex = intro.getCurrentStep();
        const currentStep = intro._options.steps[currentStepIndex];

        console.log("After change - Current step index:", currentStepIndex);
        console.log(
          "After change - Current step element:",
          currentStep?.element
        );

        // Apply entrance animation to new tooltip
        const tooltip = document.querySelector(".introjs-tooltip");
        if (tooltip) {
          // Start with entering state
          tooltip.classList.add("entering");

          // Trigger smooth entrance
          requestAnimationFrame(() => {
            tooltip.classList.remove("entering");
            tooltip.classList.add("entered");

            // Clean up after animation
            setTimeout(() => {
              tooltip.classList.remove("entered");
            }, 300);
          });

          // Special handling for feedback section on mobile
          if (
            currentStep &&
            currentStep.element === "#feedback-section" &&
            isMobileDevice()
          ) {
            tooltip.style.position = "fixed";
            tooltip.style.bottom = "20px";
            tooltip.style.left = "50%";
            tooltip.style.transform = "translateX(-50%)";
            tooltip.style.top = "auto";

            // Show arrow for feedback section
            const arrow = tooltip.querySelector(".introjs-arrow");
            if (arrow) {
              arrow.style.display = "block";
              arrow.style.borderTopColor = "#ffe0b6";
              arrow.style.borderBottomColor = "transparent";
              arrow.style.borderLeftColor = "transparent";
              arrow.style.borderRightColor = "transparent";
            }
          }
        }

        // Check if this is a mobile device and if current step is a mobile step
        if (currentStep && isMobileDevice()) {
          const mobileStepElementsWithMenuClick = [
            "#my-messages-btn",
            "#profile-btn",
            "#stats-menu-list",
          ];

          const allMobileStepElements = [
            "#stats-menu-list",
            "#feedback-section-container",
            "#my-messages-btn",
            "#ai-rec-section",
            "#profile-btn",
            "#ai-bot-btn",
            "#my-stats-btn-locked",
            "#c-metrics-button-locked",
            "#feedback-section",
            "#locked-ai-rec",
          ];

          if (allMobileStepElements.includes(currentStep.element)) {
            console.log(
              "üì± Mobile step: Now on mobile step, applying mobile logic for:",
              currentStep.element
            );

            // Hide the current step temporarily
            const tooltip = document.querySelector(".introjs-tooltip");
            const helperLayer = document.querySelector(".introjs-helperLayer");
            const overlay = document.querySelector(".introjs-overlay");

            if (tooltip) tooltip.style.display = "none";
            if (helperLayer) helperLayer.style.display = "none";
            if (overlay) overlay.style.display = "none";

            // Only click mobile menu for specific steps
            if (mobileStepElementsWithMenuClick.includes(currentStep.element)) {
              const mobileMenuBtn = document.getElementById("mobile-menu-btn");
              if (mobileMenuBtn) {
                console.log(
                  "üì± Mobile step: Clicking mobile menu button for:",
                  currentStep.element
                );
                mobileMenuBtn.click();
              } else {
                console.warn(
                  "üì± Mobile step: Mobile menu button not found for:",
                  currentStep.element
                );
              }
            }

            // Wait for UI to settle, then show the step
            setTimeout(() => {
              console.log(
                "üì± Mobile step: Delay completed, showing step for:",
                currentStep.element
              );

              if (tooltip) tooltip.style.display = "";
              if (helperLayer) helperLayer.style.display = "";
              if (overlay) overlay.style.display = "";

              // Refresh the tour to reposition tooltip
              intro.refresh();
              initializeStepImages();
            }, 700);
          } else {
            // For non-mobile steps on mobile device, just initialize images
            setTimeout(initializeStepImages, 100);
          }
        } else {
          // For all desktop steps, just initialize images
          setTimeout(initializeStepImages, 100);
        }
      });

      try {
        if (typeof window.$memberstackDom !== "undefined") {
          window.$memberstackDom
            .getCurrentMember()
            .then(function ({ data: member }) {
              if (member) {
                console.log("Member is logged in:", member);
                const membershipPlan = member.planConnections[0]; // Assuming the first plan is the active one
                console.log("Current membership plan:", membershipPlan);

                if (membershipPlan) {
                  const membershipPlanId = membershipPlan.planId;
                  console.log("Current membership ID:", membershipPlanId);

                  const advancedMembershipPlanIds = [
                    "pln_lawggle-advanced-v2-r74e0sgz",
                    "pln_lawggle-advanced-v2-a6t0erf",
                  ];

                  if (advancedMembershipPlanIds.includes(membershipPlanId)) {
                    // Use appropriate steps based on device type
                    if (isMobileDevice()) {
                      intro.setOptions({ steps: advancedMobileUserSteps });
                    } else {
                      intro.setOptions({ steps: advancedUserSteps });
                    }
                  } else {
                    // Use essential user steps
                    if (isMobileDevice()) {
                      intro.setOptions({ steps: essentialMobileUserSteps });
                    } else {
                      intro.setOptions({ steps: essentialUserSteps });
                    }
                  }
                } else {
                  console.warn(
                    "Member is logged in but has no active membership plan."
                  );
                }
              } else {
                console.log("No member is logged in.");
              }
            })
            .catch(function (error) {
              console.error("Error retrieving MemberStack member:", error);
            });
        } else {
          console.log("No member is logged in.");
        }
      } catch (error) {
        console.error("Error in MemberStack membership check:", error);
      }

      setTimeout(() => {
        // Start tour using the same configured instance
        intro.start();

        // Prevent scrolling for all devices (wheel, touch, etc.)
        document.addEventListener("wheel", preventWheelScroll, {
          passive: false,
        });
        document.addEventListener("DOMMouseScroll", preventWheelScroll, {
          passive: false,
        }); // Firefox
        // Only prevent touchmove (scrolling), allow touchstart/touchend (tapping)
        document.addEventListener("touchmove", preventTouchScroll, {
          passive: false,
        });
      }, 4000);

      // Function to prevent wheel scrolling
      function preventWheelScroll(e) {
        // Only prevent if intro is active and not scrolling within tooltip
        if (document.querySelector(".introjs-overlay")) {
          const tooltip = document.querySelector(".introjs-tooltip");
          const tooltipText = document.querySelector(".introjs-tooltiptext");

          // Allow scrolling if the wheel event is within the tooltip content
          if (tooltip && tooltip.contains(e.target)) {
            // Check if tooltip content is scrollable
            if (
              tooltipText &&
              tooltipText.scrollHeight > tooltipText.clientHeight
            ) {
              return; // Allow scrolling within tooltip
            }
          }

          e.preventDefault();
          e.stopPropagation();
        }
      }

      // Function to prevent touch scrolling/swiping
      function preventTouchScroll(e) {
        // Only prevent if intro is active and not touching within tooltip
        if (document.querySelector(".introjs-overlay")) {
          const tooltip = document.querySelector(".introjs-tooltip");
          const tooltipText = document.querySelector(".introjs-tooltiptext");

          // Allow touch scrolling if the touch event is within the tooltip content
          if (tooltip && tooltip.contains(e.target)) {
            // Check if tooltip content is scrollable
            if (
              tooltipText &&
              tooltipText.scrollHeight > tooltipText.clientHeight
            ) {
              return; // Allow scrolling within tooltip
            }
          }

          e.preventDefault();
          e.stopPropagation();
        }
      }

      intro.oncomplete(() => {
        // Remove scroll prevention for all devices
        document.removeEventListener("wheel", preventWheelScroll);
        document.removeEventListener("DOMMouseScroll", preventWheelScroll);
        document.removeEventListener("touchmove", preventTouchScroll);

        const memberstack = window.$memberstackDom;

        // memberstack.getCurrentMember().then(async ({ data: member }) => {
        //   // if the member is logged in
        //   if (member) {
        //     // Get current member's JSON
        //     let memberJson = await memberstack.getMemberJSON();

        //     // Modify or add new data
        //     memberJson.hasLoggedInBefore = true;

        //     // Update member's JSON
        //     const updatedJson = await memberstack.updateMemberJSON({
        //       json: memberJson,
        //     });

        //     console.log("Member JSON updated:", updatedJson);
        //   }
        // });
      });

      intro.onexit(() => {
        // Remove scroll prevention for all devices
        document.removeEventListener("wheel", preventWheelScroll);
        document.removeEventListener("DOMMouseScroll", preventWheelScroll);
        document.removeEventListener("touchmove", preventTouchScroll);

        const memberstack = window.$memberstackDom;

        // memberstack.getCurrentMember().then(async ({ data: member }) => {
        //   // if the member is logged in
        //   if (member) {
        //     // Get current member's JSON
        //     let memberJson = await memberstack.getMemberJSON();

        //     // Modify or add new data
        //     memberJson.hasLoggedInBefore = true;

        //     // Update member's JSON
        //     const updatedJson = await memberstack.updateMemberJSON({
        //       json: memberJson,
        //     });

        //     console.log("Member JSON updated:", updatedJson);
        //   }
        // });
      });
    }); // End of checkIfShouldRunTour().then()
  });

  function isMobileDevice() {
    return window.innerWidth <= 768;
  }
</script>
